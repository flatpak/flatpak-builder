name: Flatpak-builder CI

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

env:
  DEBIAN_FRONTEND: noninteractive
  TESTS_TIMEOUT: 10 # in minutes

jobs:
  check:
    name: Ubuntu 22.04 build
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        compiler: ['gcc', 'clang']

    env:
      UBUNTU_VERSION: '22.04'
      CC: ${{ matrix.compiler }}
      BASE_CFLAGS: -Wp,-D_FORTIFY_SOURCE=2
      BUILDDIR: builddir

    steps:
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        sudo apt-get install -y \
          ${{ matrix.compiler }} \
          attr \
          automake \
          autopoint \
          appstream-compose \
          bison \
          debugedit \
          dbus \
          desktop-file-utils \
          elfutils \
          flatpak \
          gettext \
          git \
          gobject-introspection \
          gtk-doc-tools \
          libappstream-dev \
          libarchive-dev \
          libattr1-dev \
          libcap-dev \
          libcurl4-gnutls-dev \
          libdconf-dev \
          libdw-dev \
          libelf-dev \
          libflatpak-dev \
          libfuse-dev \
          libgirepository1.0-dev \
          libglib2.0-dev \
          libgpgme11-dev \
          libjson-glib-dev \
          libostree-dev \
          libpolkit-agent-1-dev \
          libpolkit-gobject-1-dev \
          libseccomp-dev \
          libsystemd-dev \
          libxml2-utils \
          libyaml-dev \
          meson \
          ostree \
          patch \
          shared-mime-info \
          socat \
          unzip

    - name: Check out flatpak-builder
      uses: actions/checkout@v4

    - name: Configure flatpak-builder
      # TODO: Enable gtk-doc builds
      run: meson . ${BUILDDIR}

    - name: Build flatpak-builder with Meson
      run: meson compile -C ${BUILDDIR}

    - name: Run tests with Meson
      run: timeout --signal=KILL -v ${TESTS_TIMEOUT}m meson test -C ${BUILDDIR} --verbose

    - name: Upload test logs
      uses: actions/upload-artifact@v2
      if: failure() || cancelled()
      with:
        name: test logs
        path: |
          builddir/meson-logs/testlog.txt
          installed-test-logs/
