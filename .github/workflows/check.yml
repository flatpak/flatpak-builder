name: Flatpak-builder CI

on:
  push:
    branches:
    - main
    - 'flatpak-builder-1.*.x'
  pull_request:
    branches:
    - main
    - 'flatpak-builder-1.*.x'

env:
  DEBIAN_FRONTEND: noninteractive
  TESTS_TIMEOUT: 10 # in minutes

permissions:
  contents: read

jobs:
  check-meson:
    name: Ubuntu meson build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ['ubuntu-22.04', 'ubuntu-24.04']
        compiler: ['gcc', 'clang']

    env:
      CC: ${{ matrix.compiler }}
      BASE_CFLAGS: -Wp,-D_FORTIFY_SOURCE=2
      BUILDDIR: builddir
      CONFIG_OPTS: -Dinstalled_tests=true

    steps:
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ${{ matrix.compiler }} \
          attr \
          automake \
          autopoint \
          appstream-compose \
          bison \
          debugedit \
          dbus \
          desktop-file-utils \
          elfutils \
          flatpak \
          gettext \
          git \
          gobject-introspection \
          gtk-doc-tools \
          libappstream-dev \
          libarchive-dev \
          libattr1-dev \
          libcap-dev \
          libcurl4-gnutls-dev \
          libdconf-dev \
          libdw-dev \
          libelf-dev \
          libflatpak-dev \
          libfuse-dev \
          libgirepository1.0-dev \
          libglib2.0-dev \
          libgpgme11-dev \
          libjson-glib-dev \
          libostree-dev \
          libpolkit-agent-1-dev \
          libpolkit-gobject-1-dev \
          libseccomp-dev \
          libsystemd-dev \
          libxml2-utils \
          libyaml-dev \
          meson \
          ostree \
          patch \
          shared-mime-info \
          socat \
          libarchive-tools \
          docbook-xsl \
          xmlto \
          xsltproc \
          git-lfs

    - name: Check out flatpak-builder
      uses: actions/checkout@v4

    - name: Configure flatpak-builder
      run: meson setup --wrap-mode nodownload ${CONFIG_OPTS} ${BUILDDIR} .

    - name: Build flatpak-builder with Meson
      run: meson compile -C ${BUILDDIR}

    - name: Upload docs
      uses: actions/upload-artifact@v4
      with:
        if-no-files-found: error
        overwrite: true
        name: docs
        path: |
          builddir/doc/

    - name: Run tests with Meson
      run: timeout --signal=KILL -v ${TESTS_TIMEOUT}m meson test -C ${BUILDDIR} --verbose

    - name: Upload test logs
      uses: actions/upload-artifact@v4
      if: failure() || cancelled()
      with:
        name: test logs
        path: |
          builddir/meson-logs/testlog.txt
          installed-test-logs/

    - name: Configure flatpak-builder with Meson wraps
      run: meson setup --wrap-mode=forcefallback ${CONFIG_OPTS} ${BUILDDIR}_wrap .

    - name: Build flatpak-builder with Meson wraps
      run: meson compile -C ${BUILDDIR}_wrap
